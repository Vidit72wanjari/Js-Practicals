<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doctor — Appointment Booking</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --danger:#ef4444; --ok:#10b981;
    --maxw:1100px;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{background:var(--bg); margin:0; padding:24px; display:flex; justify-content:center; color:#0f172a;}
  .wrap{width:100%; max-width:var(--maxw); display:grid; grid-template-columns: 420px 1fr; gap:20px;}
  header{grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;}
  h1{font-size:18px; margin:0;}
  .card{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(12,15,20,0.06);}
  form .row{display:flex; gap:8px; margin-bottom:10px;}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
  input[type="text"], input[type="tel"], input[type="email"], select, textarea, input[type="date"], input[type="time"]{
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6eef8; background:#fcfeff; font-size:14px;
  }
  textarea{min-height:74px; resize:vertical;}
  button{background:var(--accent); color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer;}
  button.ghost{background:transparent; color:var(--accent); border:1px solid #dbeafe;}
  .small{font-size:13px; padding:6px 8px; border-radius:8px;}
  .muted{color:var(--muted); font-size:13px;}
  .dashboard-controls{display:flex; gap:8px; align-items:center; margin-bottom:12px;}
  .appointments{display:grid; gap:10px;}
  .appt{display:flex; gap:12px; padding:12px; border-radius:10px; align-items:center; justify-content:space-between;}
  .appt .left{display:flex; gap:12px; align-items:center;}
  .avatar{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#e0f2fe,#c7f9d6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#0f172a;}
  .meta{min-width:0;}
  .meta b{display:block; font-size:15px;}
  .meta .sub{font-size:13px; color:var(--muted);}
  .status{padding:6px 8px;border-radius:8px;font-size:13px;}
  .status.requested{background:#fffbeb;color:#92400e}
  .status.confirmed{background:#ecfeff;color:#065f46}
  .status.completed{background:#eef2ff;color:#3730a3}
  .status.cancelled{background:#fff1f2;color:#991b1b}
  .actions{display:flex; gap:6px;}
  .pill{background:#f1f5f9;padding:6px 8px;border-radius:8px;font-size:13px;color:#0f172a;border:1px solid #eef2ff;}
  .filter-row{display:flex; gap:8px; align-items:center;}
  @media (max-width:980px){
    .wrap{grid-template-columns: 1fr; padding:8px;}
  }
  .inline-edit{display:flex; gap:8px; align-items:center;}
  .empty{padding:20px; text-align:center; color:var(--muted);}
  .danger{background:var(--danger); color:white;}
  .ok{background:var(--ok); color:white;}
  .topbar{display:flex; gap:12px; align-items:center;}
  .search{padding:8px 10px; border-radius:8px; border:1px solid #e6eef8;}
  .note{font-size:12px;color:var(--muted); margin-top:6px;}
  .tiny{font-size:12px;color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Doctor — Appointment Booking System</h1>
    <div class="topbar">
      <div class="tiny">Local demo — data saved to this browser</div>
    </div>
  </header>

  <!-- Left column: Booking form (patient) -->
  <section class="card" aria-labelledby="bookTitle">
    <h2 id="bookTitle" style="margin:0 0 10px 0;font-size:16px;">Book Appointment</h2>
    <form id="bookForm" autocomplete="off">
      <div class="row">
        <div style="flex:1">
          <label for="patientName">Patient name</label>
          <input id="patientName" type="text" required />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="phone">Phone</label>
          <input id="phone" type="tel" placeholder="+91XXXXXXXXXX" required />
        </div>
        <div style="width:140px">
          <label for="doctor">Doctor</label>
          <select id="doctor" required>
            <option value="">Select</option>
            <option>Dr. A. Sharma — General</option>
            <option>Dr. R. Patel — Cardiologist</option>
            <option>Dr. S. Rao — ENT</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="date">Date</label>
          <input id="date" type="date" required />
        </div>
        <div style="width:140px">
          <label for="time">Time</label>
          <input id="time" type="time" required />
        </div>
      </div>

      <div>
        <label for="email">Email (optional)</label>
        <input id="email" type="email" />
      </div>

      <div style="margin-top:10px;">
        <label for="reason">Reason / Notes</label>
        <textarea id="reason" placeholder="Short reason or symptoms"></textarea>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button type="submit">Request Appointment</button>
        <button type="button" class="ghost small" id="clearForm">Clear</button>
        <div class="note">Requests appear instantly in the Doctor Dashboard below.</div>
      </div>
    </form>
  </section>

  <!-- Right column: Doctor dashboard -->
  <section class="card" aria-labelledby="dashTitle">
    <h2 id="dashTitle" style="margin:0 0 10px 0;font-size:16px;">Doctor Dashboard</h2>

    <div class="dashboard-controls">
      <div class="filter-row" style="flex:1">
        <select id="statusFilter" class="small">
          <option value="all">All statuses</option>
          <option value="requested">Requested</option>
          <option value="confirmed">Confirmed</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>

        <input id="dateFilter" type="date" class="small" />
        <input id="searchBox" class="search" placeholder="Search patient, doctor or phone" />
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="exportBtn" class="small ghost">Export JSON</button>
        <button id="clearAll" class="small ghost">Clear All</button>
      </div>
    </div>

    <div id="appointments" class="appointments">
      <!-- JS inserts appointment cards here -->
    </div>

    <div id="emptyState" class="empty" style="display:none;">
      No appointments. Use the booking form to create requests.
    </div>
  </section>
</div>

<script>
/* Appointment Booking — single-file frontend
   Features:
   - create requests, list, confirm, reschedule, complete, cancel, delete
   - filters: status, date, search
   - persistence: localStorage
*/

/* --------- Utilities & Data Layer --------- */
const LS_KEY = 'doctor_appointments_v1';

function uid(prefix='id'){
  return prefix + '_' + Math.random().toString(36).slice(2,9);
}

function loadAppointments(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){
    console.error('Failed to load', e);
    return [];
  }
}
function saveAppointments(list){
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}

/* --------- Initial state & DOM refs --------- */
let appointments = loadAppointments();
const form = document.getElementById('bookForm');
const patientName = document.getElementById('patientName');
const phone = document.getElementById('phone');
const email = document.getElementById('email');
const doctorSel = document.getElementById('doctor');
const dateInp = document.getElementById('date');
const timeInp = document.getElementById('time');
const reasonInp = document.getElementById('reason');
const appointmentsDiv = document.getElementById('appointments');
const emptyState = document.getElementById('emptyState');

const statusFilter = document.getElementById('statusFilter');
const dateFilter = document.getElementById('dateFilter');
const searchBox = document.getElementById('searchBox');
const exportBtn = document.getElementById('exportBtn');
const clearAllBtn = document.getElementById('clearAll');
const clearFormBtn = document.getElementById('clearForm');

/* --------- Validation & helpers --------- */
function validateForm(data){
  if(!data.patientName.trim()) return 'Enter patient name';
  if(!/^\+?\d{7,15}$/.test(data.phone.trim())) return 'Enter valid phone (digits, optional +)';
  if(!data.doctor) return 'Select a doctor';
  if(!data.date) return 'Select a date';
  if(!data.time) return 'Select a time';
  // Prevent past date/time
  const dt = new Date(data.date + 'T' + data.time);
  if(isNaN(dt)) return 'Invalid date/time';
  if(dt < new Date()) return 'Date/time must be in the future';
  return null;
}

function humanDateTime(appt){
  const d = new Date(appt.date + 'T' + appt.time);
  return d.toLocaleString();
}

/* --------- Render logic --------- */
function render(){
  const filterStatus = statusFilter.value;
  const filterDate = dateFilter.value;
  const q = searchBox.value.trim().toLowerCase();
  const list = appointments
    .filter(a => filterStatus === 'all' ? true : a.status === filterStatus)
    .filter(a => filterDate ? a.date === filterDate : true)
    .filter(a => {
      if(!q) return true;
      return (a.patientName + ' ' + a.doctor + ' ' + a.phone + ' ' + (a.email||'') + ' ' + a.reason).toLowerCase().includes(q);
    })
    .sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

  appointmentsDiv.innerHTML = '';
  if(list.length === 0){
    emptyState.style.display = '';
    return;
  } else {
    emptyState.style.display = 'none';
  }

  list.forEach(a => {
    const card = document.createElement('div');
    card.className = 'appt card';
    const left = document.createElement('div'); left.className='left';
    const avatar = document.createElement('div'); avatar.className='avatar';
    avatar.textContent = a.patientName.split(' ').map(x=>x[0]||'').slice(0,2).join('').toUpperCase();
    const meta = document.createElement('div'); meta.className='meta';
    const title = document.createElement('b'); title.textContent = a.patientName;
    const sub = document.createElement('div'); sub.className='sub';
    sub.innerHTML = `${a.doctor} • ${humanDateTime(a)}<br><span class="muted">Phone: ${a.phone}${a.email? ' • ' + a.email:''}</span><div class="note">${a.reason || ''}</div>`;

    meta.appendChild(title); meta.appendChild(sub);
    left.appendChild(avatar); left.appendChild(meta);

    const right = document.createElement('div'); right.style.textAlign='right';
    const status = document.createElement('div'); status.className = 'status ' + a.status;
    status.textContent = a.status;
    const actions = document.createElement('div'); actions.className = 'actions';

    // Action buttons per status
    if(a.status === 'requested'){
      const confirmBtn = makeBtn('Confirm', ()=>updateStatus(a.id,'confirmed'));
      const resBtn = makeBtn('Reschedule', ()=>openReschedule(a.id));
      actions.appendChild(confirmBtn); actions.appendChild(resBtn);
    } else if(a.status === 'confirmed'){
      const completeBtn = makeBtn('Complete', ()=>updateStatus(a.id,'completed'),'ok');
      const resBtn = makeBtn('Reschedule', ()=>openReschedule(a.id));
      actions.appendChild(completeBtn); actions.appendChild(resBtn);
    } else {
      const resBtn = makeBtn('Reschedule', ()=>openReschedule(a.id));
      actions.appendChild(resBtn);
    }

    const cancelBtn = makeBtn('Cancel', ()=>updateStatus(a.id,'cancelled'),'danger');
    const deleteBtn = makeBtn('Delete', ()=>deleteAppointment(a.id));
    actions.appendChild(cancelBtn); actions.appendChild(deleteBtn);

    right.appendChild(status);
    right.appendChild(actions);

    card.appendChild(left);
    card.appendChild(right);
    appointmentsDiv.appendChild(card);
  });
}

function makeBtn(text, onClick, style){
  const b = document.createElement('button');
  b.textContent = text;
  b.className = 'small';
  if(style==='danger') b.classList.add('danger');
  if(style==='ok') b.classList.add('ok');
  b.addEventListener('click', (e)=>{ e.preventDefault(); onClick(); });
  return b;
}

/* --------- Actions --------- */
function addAppointment(data){
  const appt = {
    id: uid('appt'),
    patientName: data.patientName.trim(),
    phone: data.phone.trim(),
    email: (data.email||'').trim(),
    doctor: data.doctor,
    date: data.date,
    time: data.time,
    reason: (data.reason||'').trim(),
    status: 'requested',
    createdAt: new Date().toISOString()
  };
  appointments.push(appt);
  saveAppointments(appointments);
  render();
}

function updateStatus(id, status){
  const idx = appointments.findIndex(a=>a.id===id);
  if(idx===-1) return alert('Appointment not found');
  appointments[idx].status = status;
  saveAppointments(appointments);
  render();
}

function deleteAppointment(id){
  if(!confirm('Delete this appointment? This cannot be undone.')) return;
  appointments = appointments.filter(a=>a.id!==id);
  saveAppointments(appointments);
  render();
}

/* Inline reschedule editor */
function openReschedule(id){
  const appt = appointments.find(a=>a.id===id);
  if(!appt) return alert('Not found');
  // Create small modal-like inline editor
  const container = document.createElement('div');
  container.className = 'card';
  container.style.position='fixed';
  container.style.left='50%';
  container.style.top='50%';
  container.style.transform='translate(-50%,-50%)';
  container.style.zIndex=9999;
  container.style.width='360px';
  container.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <strong>Reschedule: ${appt.patientName}</strong>
      <button id="closeX" class="ghost small">X</button>
    </div>
    <label class="tiny">Date</label>
    <input id="rsDate" type="date" style="width:100%;margin-bottom:8px" value="${appt.date}" />
    <label class="tiny">Time</label>
    <input id="rsTime" type="time" style="width:100%;margin-bottom:8px" value="${appt.time}" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="rsSave" class="ok small">Save</button>
      <button id="rsCancel" class="small ghost">Cancel</button>
    </div>
  `;
  document.body.appendChild(container);
  document.getElementById('closeX').addEventListener('click', ()=>container.remove());
  document.getElementById('rsCancel').addEventListener('click', ()=>container.remove());
  document.getElementById('rsSave').addEventListener('click', ()=>{
    const newDate = document.getElementById('rsDate').value;
    const newTime = document.getElementById('rsTime').value;
    const err = validateForm({patientName: appt.patientName, phone: appt.phone, doctor: appt.doctor, date: newDate, time: newTime});
    if(err){ alert(err); return; }
    appt.date = newDate; appt.time = newTime;
    // when rescheduled, keep previous status; optionally set to requested
    saveAppointments(appointments);
    render();
    container.remove();
  });
}

/* --------- Wiring form & controls --------- */
form.addEventListener('submit', e=>{
  e.preventDefault();
  const data = {
    patientName: patientName.value,
    phone: phone.value,
    email: email.value,
    doctor: doctorSel.value,
    date: dateInp.value,
    time: timeInp.value,
    reason: reasonInp.value
  };
  const err = validateForm(data);
  if(err){ alert(err); return; }
  addAppointment(data);
  form.reset();
  alert('Appointment requested');
});

clearFormBtn.addEventListener('click', ()=>form.reset());

statusFilter.addEventListener('change', render);
dateFilter.addEventListener('change', render);
searchBox.addEventListener('input', debounce(render, 250));

exportBtn.addEventListener('click', ()=>{
  const dataStr = JSON.stringify(appointments, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'appointments.json';
  document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});

clearAllBtn.addEventListener('click', ()=>{
  if(!confirm('Clear all appointments from local storage?')) return;
  appointments = [];
  saveAppointments(appointments);
  render();
});

/* Debounce helper */
function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

/* Keyboard shortcuts (optional) */
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key==='f'){ e.preventDefault(); searchBox.focus(); }
});

/* Initial render */
render();
</script>
</body>
</html>
